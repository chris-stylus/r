<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDAYA Smart Result Console</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --brand-primary: #1e1b4b; 
            --brand-accent: #3b82f6;  
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
        }

        /* Fixed A4 Structure - Locked dimensions to prevent overlap */
        .report-card-container {
            width: 210mm;
            height: 297mm;
            padding: 10mm 15mm;
            background: white;
            margin: 0 auto;
            position: relative;
            box-sizing: border-box;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            page-break-after: always;
        }
        
        #preview-view .report-card-container {
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            border-radius: 4px;
        }

        /* Fixed Section Heights in mm */
        .header-box { height: 38mm; margin-bottom: 4mm; }
        .info-box { height: 28mm; margin-bottom: 4mm; }
        .scholastic-box { height: 82mm; margin-bottom: 8mm; } 
        .metrics-row { height: 46mm; margin-bottom: 4mm; }
        .summary-row { height: 22mm; margin-bottom: 4mm; }
        .appraisal-box { height: 20mm; }
        
        .footer-sigs { 
            position: absolute; 
            bottom: 12mm; 
            left: 15mm; 
            right: 15mm; 
            height: 15mm; 
        }

        /* Marks Table - Fixed at 8 rows */
        .marks-table {
            width: 100%;
            height: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            border: 1.5px solid #1e1b4b;
        }

        .marks-table thead tr { height: 9mm; background: #1e1b4b; color: white; }
        .marks-row { height: 9.1mm; } 

        .marks-row td {
            padding: 0 8px !important;
            vertical-align: middle;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid #cbd5e1;
        }

        .loader-spin {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--brand-primary);
            border-radius: 50%;
            width: 32px; height: 32px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #print-container {
            position: fixed;
            top: 0;
            left: -10000px;
            width: 210mm;
            z-index: -1;
            background: white;
        }

        .grade-A { background: #dcfce7; color: #166534; }
        .grade-B { background: #dbeafe; color: #1e40af; }
        .grade-C { background: #fef9c3; color: #854d0e; }
        .grade-D { background: #fee2e2; color: #991b1b; }

        .tab-active {
            border-bottom: 3px solid var(--brand-accent);
            color: var(--brand-accent);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/95 backdrop-blur-md z-[100] hidden flex flex-col items-center justify-center">
        <div class="loader-spin mb-4"></div>
        <p id="loading-text" class="font-bold text-slate-800 text-xs tracking-widest uppercase">System Syncing...</p>
        <p id="loading-progress" class="text-[10px] text-blue-500 font-bold mt-2"></p>
    </div>

    <!-- UI Header -->
    <header class="bg-blue-950 text-white p-5 shadow-xl no-print z-50 sticky top-0">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="p-2.5 bg-blue-500 rounded-xl shadow-lg">
                    <i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase leading-none">UDAYA <span class="text-blue-400">SMART</span></h1>
                    <p class="text-[10px] font-bold text-blue-300 tracking-[0.2em] uppercase mt-1">Professional Cloud Result Console</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="sync-indicator" class="flex items-center gap-2 text-[9px] font-black bg-emerald-500/20 text-emerald-400 px-3 py-1.5 rounded-full border border-emerald-500/30 hidden">
                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span> PERSISTENT DATA ON
                </div>
                <button id="reset-btn" onclick="resetApp()" class="text-[10px] font-black bg-white/10 hover:bg-red-500/20 px-4 py-2 rounded-lg border border-white/5 uppercase transition-all">Clear All Data</button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-white border-b border-slate-200 no-print sticky top-[76px] z-40">
        <div class="container mx-auto flex">
            <button onclick="switchTab('upload')" id="tab-upload-btn" class="px-8 py-4 text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 tab-active">
                <i data-lucide="upload-cloud" class="w-4 h-4"></i> 1. Upload & Configure
            </button>
            <button onclick="switchTab('result')" id="tab-result-btn" class="px-8 py-4 text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 text-slate-400">
                <i data-lucide="file-check" class="w-4 h-4"></i> 2. Get Results
            </button>
        </div>
    </nav>

    <main class="container mx-auto p-6 flex-grow">
        <div id="toast-container" class="fixed bottom-8 right-8 z-[110] flex flex-col gap-3"></div>

        <!-- TAB 1: UPLOAD VIEW -->
        <div id="view-upload" class="max-w-6xl mx-auto mt-6 grid lg:grid-cols-12 gap-8 animate-in fade-in duration-300">
            <div class="lg:col-span-8">
                <div class="bg-white rounded-[2.5rem] shadow-2xl p-10 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2 tracking-tight">Academic Central</h2>
                    <p class="text-slate-500 mb-8 font-medium font-semibold">Data is automatically saved to your cloud account.</p>
                    
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div class="p-6 bg-slate-900 rounded-3xl shadow-xl">
                             <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 flex items-center gap-2">
                                <i data-lucide="crosshair" class="w-4 h-4 text-blue-400"></i> Step 1: Active Target
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[9px] font-black text-slate-500 uppercase mb-1 block">Class</label>
                                    <select id="upload-class-select" onchange="handleTargetChange()" class="w-full px-4 py-3 rounded-xl border-none bg-slate-800 text-white text-xs font-black outline-none cursor-pointer"></select>
                                </div>
                                <div>
                                    <label class="text-[9px] font-black text-slate-500 uppercase mb-1 block">Section</label>
                                    <input type="text" id="upload-section-input" onkeyup="handleTargetChange()" placeholder="e.g. A" class="w-full px-4 py-3 rounded-xl border-none bg-slate-800 text-white text-xs font-bold outline-none uppercase">
                                </div>
                                <button onclick="addClassModal()" class="w-full py-2 border border-slate-700 text-slate-400 text-[10px] font-black uppercase rounded-lg hover:bg-slate-800 transition">+ New Class Type</button>
                            </div>
                        </div>

                        <div class="p-6 bg-blue-50/50 rounded-3xl border border-blue-100 flex flex-col">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-blue-500 mb-4">
                                <span class="flex items-center gap-2"><i data-lucide="settings-2" class="w-4 h-4"></i> Step 2: Subjects for <span id="current-target-label" class="text-blue-700">Class</span></span>
                            </h3>
                            <div id="subject-list" class="flex flex-wrap gap-2 mb-4 flex-1 content-start overflow-y-auto max-h-[160px]"></div>
                            <div class="flex gap-2 mt-4 pt-4 border-t border-blue-100">
                                <input type="text" id="new-subject-input" placeholder="Subject name..." class="flex-1 px-4 py-2 rounded-xl border border-blue-200 text-xs font-bold outline-none">
                                <button onclick="addSubject()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase transition-all">Add</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid sm:grid-cols-2 gap-6">
                        <button onclick="downloadTemplate()" class="group flex flex-col items-center justify-center gap-4 bg-white text-slate-700 p-8 rounded-3xl hover:bg-blue-50 transition-all font-bold border-2 border-dashed border-slate-200">
                            <div class="p-4 bg-slate-50 rounded-2xl shadow-sm"><i data-lucide="file-spreadsheet" class="w-8 h-8"></i></div>
                            <span class="text-xs uppercase tracking-[0.15em]">Get Template</span>
                        </button>
                        <div class="relative group cursor-pointer">
                            <input type="file" id="file-upload" accept=".xlsx, .xls" onchange="handleFileUpload(this)" class="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer" />
                            <div class="bg-blue-600 border-4 border-blue-500 rounded-3xl p-8 group-hover:bg-blue-700 transition-all shadow-xl shadow-blue-200 flex flex-col items-center">
                                <div class="p-4 bg-white/10 rounded-2xl mb-4 inline-block"><i data-lucide="upload-cloud" class="w-8 h-8 text-white"></i></div>
                                <p class="text-white text-xs font-black uppercase tracking-[0.15em]">Upload Result Sheet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLOUD BAR -->
            <div id="cloud-history-section" class="lg:col-span-4 bg-white rounded-[2rem] shadow-xl border border-slate-100 flex flex-col overflow-hidden hidden">
                <div class="p-6 bg-slate-50 border-b flex items-center justify-between">
                    <h3 class="font-black text-slate-800 text-[10px] uppercase tracking-widest flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-blue-600"></i> Local Batches</h3>
                </div>
                <div id="cloud-history-list" class="flex-1 overflow-y-auto max-h-[600px] divide-y divide-slate-50"></div>
            </div>
        </div>

        <!-- TAB 2: RESULT VIEW -->
        <div id="view-result" class="hidden animate-in slide-in-from-bottom-4 duration-500">
            <div id="no-data-placeholder" class="bg-white rounded-[2.5rem] p-20 text-center border-2 border-dashed border-slate-200 max-w-4xl mx-auto mt-10">
                <div class="p-6 bg-slate-50 rounded-full inline-block mb-6"><i data-lucide="database-zap" class="w-12 h-12 text-slate-300"></i></div>
                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">No Records Processed</h3>
                <p class="text-slate-400 mt-2 font-medium">Excel file upload karo records dekhne ke liye.</p>
                <button onclick="switchTab('upload')" class="mt-8 bg-blue-600 text-white px-8 py-3 rounded-2xl font-black text-xs uppercase hover:bg-blue-700 transition shadow-lg">Go to Upload</button>
            </div>

            <div id="result-content" class="hidden bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden no-print">
                <div class="p-8 bg-slate-50 border-b flex flex-wrap gap-6 items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-900 text-white w-14 h-14 rounded-2xl flex items-center justify-center text-2xl font-black" id="student-count">0</div>
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest">Active Database</h3>
                    </div>
                    <div class="flex gap-3 flex-wrap items-center">
                        <select id="filter-class-select" onchange="filterStudents()" class="px-5 py-3.5 rounded-2xl border border-slate-200 bg-white text-xs font-black outline-none cursor-pointer"></select>
                        <input type="text" id="search-input" onkeyup="filterStudents()" placeholder="Search Name..." class="px-5 py-3.5 rounded-2xl border border-slate-200 bg-white text-xs font-bold outline-none w-60">
                        <button onclick="saveToCloud()" class="bg-emerald-600 text-white px-6 py-3.5 rounded-2xl font-black text-[10px] uppercase transition shadow-lg"><i data-lucide="archive" class="w-4 h-4 mr-2"></i>Archive Batch</button>
                        <button onclick="downloadBatchPDF()" class="bg-blue-900 text-white px-6 py-3.5 rounded-2xl font-black text-[10px] uppercase transition shadow-xl"><i data-lucide="layers" class="w-4 h-4 mr-2"></i>Export Filtered</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] border-b">
                            <tr><th class="p-8 text-left">Identity</th><th class="p-8 text-left">Aggregate Analysis</th><th class="p-8 text-center">Grade</th><th class="p-8 text-center">Status</th><th class="p-8 text-right">Action</th></tr>
                        </thead>
                        <tbody id="students-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PREVIEW VIEW -->
        <div id="preview-view" class="hidden py-8 animate-in fade-in duration-700">
            <div class="max-w-[210mm] mx-auto mb-10 flex justify-between items-center no-print px-4">
                <button onclick="showListView()" class="group flex items-center gap-3 font-black text-[10px] tracking-widest text-slate-400 hover:text-blue-900 transition-all uppercase">
                    <div class="p-2 bg-slate-100 rounded-lg group-hover:bg-blue-100 transition-all"><i data-lucide="chevron-left" class="w-4 h-4"></i></div> Exit Preview
                </button>
                <button onclick="downloadSinglePDF()" class="bg-blue-900 text-white px-10 py-4 rounded-2xl font-black text-[10px] tracking-widest uppercase shadow-2xl hover:bg-black transition-all flex items-center gap-3">
                    <i data-lucide="file-text" class="w-4 h-4"></i> Download One-Page PDF
                </button>
            </div>
            <div id="single-report-container"></div>
        </div>
    </main>

    <!-- Hidden Batch Rendering Container -->
    <div id="print-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, getDocs, deleteDoc, onSnapshot, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State & Firebase Init
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'udaya-smart-2025';

        let currentUser = null;
        window.studentsData = [];

        // Auth Logic
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth failed", e);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('sync-indicator')?.classList.remove('hidden');
                setupRealtimeSync(user.uid);
                loadArchives(user.uid);
            }
        });

        // Persistent Database Sync
        function setupRealtimeSync(userId) {
            const colRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
            onSnapshot(colRef, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.studentsData = data;
                if (data.length > 0) {
                    updateFilterDropdown();
                    renderListView();
                }
            }, (error) => {
                console.error("Firestore sync error", error);
            });
        }

        // Global DB Functions exposed to window
        window.dbSync = {
            async saveStudents(students, targetClass, targetSection) {
                if (!currentUser) return;
                setLoading(true, "Syncing to Cloud...");
                try {
                    const userId = currentUser.uid;
                    const colRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
                    
                    // Rule 2: Fetch all then filter in memory for overwrite logic
                    const snap = await getDocs(colRef);
                    const batch = writeBatch(db);
                    
                    // Delete existing students of SAME class/section
                    snap.forEach(d => {
                        const s = d.data();
                        if (s.Class === targetClass && s.Section === targetSection) {
                            batch.delete(doc(colRef, d.id));
                        }
                    });

                    // Add new students
                    students.forEach(s => {
                        const newDoc = doc(colRef);
                        batch.set(newDoc, s);
                    });

                    await batch.commit();
                    showToast("Cloud Sync Complete", "success");
                } catch (e) {
                    showToast("Sync Error", "error");
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            },
            
            async clearAll() {
                if (!currentUser) return;
                if (!confirm("Permanently delete ALL records from cloud?")) return;
                setLoading(true, "Cleaning Cloud...");
                try {
                    const userId = currentUser.uid;
                    const colRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
                    const snap = await getDocs(colRef);
                    const batch = writeBatch(db);
                    snap.forEach(d => batch.delete(doc(colRef, d.id)));
                    await batch.commit();
                    showToast("Cloud Database Wiped", "success");
                    window.studentsData = [];
                    renderListView();
                } finally {
                    setLoading(false);
                }
            }
        };

        // Batch Archiving (Legacy Backup feature)
        window.saveToCloud = async () => {
            if (!currentUser || !window.studentsData || window.studentsData.length === 0) return;
            const batchName = prompt("Archive Name:", `Archive_${new Date().toLocaleDateString()}`);
            if (!batchName) return;
            setLoading(true, "Archiving...");
            try {
                const batchId = crypto.randomUUID();
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'batches', batchId), {
                    name: batchName, data: window.studentsData, compositeSubjectMap: window.classSectionSubjectMap, count: window.studentsData.length, timestamp: serverTimestamp()
                });
                showToast("Archive Created", "success");
            } catch (e) { showToast("Save Failed", "error"); } finally { setLoading(false); }
        };

        async function loadArchives(userId) {
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'users', userId, 'batches'));
                const container = document.getElementById('cloud-history-list');
                const section = document.getElementById('cloud-history-section');
                if (snap.empty) { section.classList.add('hidden'); return; }
                section.classList.remove('hidden');
                let batches = [];
                snap.forEach(d => batches.push({ id: d.id, ...d.data() }));
                batches.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                container.innerHTML = batches.map(b => `
                    <div class="p-5 hover:bg-blue-50/50 transition flex justify-between items-center group">
                        <div class="flex-1">
                            <p class="font-bold text-slate-800 text-xs uppercase truncate">${b.name}</p>
                            <p class="text-[9px] text-slate-400 font-black uppercase mt-1 tracking-widest">${b.count} Students</p>
                        </div>
                        <button onclick="loadBatch('${b.id}')" class="p-2 bg-blue-100 text-blue-700 rounded-lg opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="download" class="w-4 h-4"></i></button>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (e) {}
        }

        window.loadBatch = async (id) => {
            setLoading(true, "Restoring Archive...");
            try {
                const d = await getDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'batches', id));
                if (d.exists()) {
                    const b = d.data();
                    if (b.compositeSubjectMap) window.classSectionSubjectMap = b.compositeSubjectMap;
                    // Ask if they want to replace active DB
                    if(confirm("Restore this archive to active database? (Existing cloud data will be overwritten)")) {
                        await window.dbSync.saveStudents(b.data, "RESTORED", "BATCH");
                    }
                }
            } finally { setLoading(false); }
        };

        initAuth();
    </script>

    <script>
        // UI Helpers
        window.activeClasses = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII"];
        window.classSectionSubjectMap = {
            "I-A": ["English", "Hindi", "Maths", "EVS"],
            "X-A": ["English", "Hindi", "Maths", "Science", "SST", "IT"]
        };
        const classBaseSubjects = {
            "I": ["English", "Hindi", "Maths", "EVS"],
            "IX": ["English", "Hindi", "Maths", "Science", "SST", "IT"],
            "X": ["English", "Hindi", "Maths", "Science", "SST", "IT"],
            "XI": ["English", "Physics", "Chemistry", "Maths", "Biology"],
            "XII": ["English", "Physics", "Chemistry", "Maths", "Biology"]
        };

        const SCHOOL = {
            name: "UDAYA PUBLIC SCHOOL",
            loc: "Mahadev Jharkhandi, Kunraghat, Gorakhpur, UP",
            sess: "ACADEMIC SESSION 2025–2026"
        };
        const apiKey = ""; 

        lucide.createIcons();

        // --- Tab Management ---
        window.switchTab = (tab) => {
            const uploadBtn = document.getElementById('tab-upload-btn');
            const resultBtn = document.getElementById('tab-result-btn');
            const viewUpload = document.getElementById('view-upload');
            const viewResult = document.getElementById('view-result');
            const previewView = document.getElementById('preview-view');
            previewView.classList.add('hidden');
            if (tab === 'upload') {
                uploadBtn.classList.add('tab-active'); uploadBtn.classList.remove('text-slate-400');
                resultBtn.classList.remove('tab-active'); resultBtn.classList.add('text-slate-400');
                viewUpload.classList.remove('hidden'); viewResult.classList.add('hidden');
            } else {
                resultBtn.classList.add('tab-active'); resultBtn.classList.remove('text-slate-400');
                uploadBtn.classList.remove('tab-active'); uploadBtn.classList.add('text-slate-400');
                viewUpload.classList.add('hidden'); viewResult.classList.remove('hidden');
                if (window.studentsData && window.studentsData.length > 0) {
                    document.getElementById('no-data-placeholder').classList.add('hidden');
                    document.getElementById('result-content').classList.remove('hidden');
                    updateFilterDropdown(); renderListView();
                } else {
                    document.getElementById('no-data-placeholder').classList.remove('hidden');
                    document.getElementById('result-content').classList.add('hidden');
                }
            }
            lucide.createIcons();
        };

        window.resetApp = () => {
            if (window.dbSync) window.dbSync.clearAll();
        };

        // --- Config Logic ---
        window.handleTargetChange = () => {
            const cls = document.getElementById('upload-class-select').value;
            const sec = document.getElementById('upload-section-input').value.trim().toUpperCase() || 'A';
            document.getElementById('current-target-label').innerText = `${cls} - ${sec}`;
            const key = `${cls}-${sec}`;
            if (!window.classSectionSubjectMap[key]) {
                window.classSectionSubjectMap[key] = [...(classBaseSubjects[cls] || ["English", "Hindi", "Maths"])];
            }
            window.renderSubjectList();
        };

        window.renderClassList = () => {
            const select = document.getElementById('upload-class-select');
            const currentVal = select.value || window.activeClasses[0];
            select.innerHTML = window.activeClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            select.value = window.activeClasses.includes(currentVal) ? currentVal : window.activeClasses[0];
            window.handleTargetChange();
        };

        window.addClassModal = () => {
            const name = prompt("Enter Class Identifier:")?.trim().toUpperCase();
            if (!name) return;
            if (window.activeClasses.includes(name)) return;
            window.activeClasses.push(name);
            window.renderClassList();
        };

        window.renderSubjectList = () => {
            const cls = document.getElementById('upload-class-select').value;
            const sec = document.getElementById('upload-section-input').value.trim().toUpperCase() || 'A';
            const key = `${cls}-${sec}`;
            const subjects = window.classSectionSubjectMap[key] || [];
            document.getElementById('subject-list').innerHTML = subjects.map((s, idx) => `
                <div class="bg-white border border-blue-200 pl-3 pr-2 py-1.5 rounded-xl flex items-center gap-2 shadow-sm group">
                    <span class="text-[10px] font-black uppercase text-blue-800">${s}</span>
                    <button onclick="removeSubject(${idx})" class="p-1 hover:bg-red-50 text-slate-300 hover:text-red-500 rounded-md transition-all"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.addSubject = () => {
            const cls = document.getElementById('upload-class-select').value;
            const sec = document.getElementById('upload-section-input').value.trim().toUpperCase() || 'A';
            const key = `${cls}-${sec}`;
            if (window.classSectionSubjectMap[key].length >= 8) { showToast("Limit reached (Max 8)", "error"); return; }
            const input = document.getElementById('new-subject-input');
            const name = input.value.trim();
            if (!name) return;
            if (window.classSectionSubjectMap[key].includes(name)) return;
            window.classSectionSubjectMap[key].push(name);
            input.value = '';
            window.renderSubjectList();
        };

        window.removeSubject = (idx) => {
            const cls = document.getElementById('upload-class-select').value;
            const sec = document.getElementById('upload-section-input').value.trim().toUpperCase() || 'A';
            const key = `${cls}-${sec}`;
            if (window.classSectionSubjectMap[key].length <= 1) return;
            window.classSectionSubjectMap[key].splice(idx, 1);
            window.renderSubjectList();
        };

        // --- Analysis & Persistence Logic ---
        function updateFilterDropdown() {
            const select = document.getElementById('filter-class-select');
            const uniqueClasses = [...new Set(window.studentsData.map(s => s.Class))].sort();
            const currentVal = select.value;
            select.innerHTML = '<option value="ALL">ALL CLASSES</option>' + uniqueClasses.map(c => `<option value="${c}">CLASS ${c}</option>`).join('');
            if (currentVal && [...uniqueClasses, "ALL"].includes(currentVal)) select.value = currentVal;
        }

        function getFilteredList() {
            const queryText = document.getElementById('search-input').value.toLowerCase();
            const classFilter = document.getElementById('filter-class-select').value;
            return window.studentsData.filter(s => {
                const matchesName = String(s.Student_Name || '').toLowerCase().includes(queryText);
                const matchesClass = (classFilter === 'ALL' || s.Class === classFilter);
                return matchesName && matchesClass;
            });
        }

        function renderListView() {
            const filtered = getFilteredList();
            document.getElementById('student-count').innerText = filtered.length;
            const body = document.getElementById('students-table-body');
            body.innerHTML = filtered.map(s => `
                <tr class="hover:bg-slate-50 border-b border-slate-50 transition-colors">
                    <td class="p-8">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-black text-blue-700 text-[10px]">${s.Student_Name?.[0] || 'S'}</div>
                            <div>
                                <div class="font-black text-slate-800 text-sm uppercase">${s.Student_Name}</div>
                                <div class="text-[9px] text-slate-400 font-black uppercase mt-0.5 tracking-widest">CLASS ${s.Class} • SEC ${s.Section} • ADM: ${s.Admission_No}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-8"><div class="w-32 bg-slate-100 h-2 rounded-full overflow-hidden mb-2"><div class="bg-blue-600 h-full transition-all duration-1000" style="width: ${s.overallPerc}%"></div></div><div class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${s.overallPerc}% Aggregate</div></td>
                    <td class="p-8 text-center"><span class="${s.overallGradeClass} px-3 py-1 rounded-lg text-[10px] font-black">${s.overallGrade}</span></td>
                    <td class="p-8 text-center"><span class="text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest ${s.status === 'PASSED' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${s.status}</span></td>
                    <td class="p-8 text-right"><button onclick="previewStudent('${s.id}')" class="text-blue-600 font-black text-[10px] uppercase tracking-widest underline decoration-2 underline-offset-4 hover:text-black transition">Preview</button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        window.filterStudents = () => renderListView();

        function getGrade(p) {
            if (p >= 91) return { l: 'A1', c: 'grade-A' };
            if (p >= 81) return { l: 'A2', c: 'grade-A' };
            if (p >= 71) return { l: 'B1', c: 'grade-B' };
            if (p >= 61) return { l: 'B2', c: 'grade-B' };
            if (p >= 51) return { l: 'C1', c: 'grade-C' };
            if (p >= 41) return { l: 'C2', c: 'grade-C' };
            return { l: 'D', c: 'grade-D' };
        }

        async function generateAIRemark(student, type) {
            const prompt = type === 'teacher' ? 
                `1 strictly positive professional appraisal for student ${student.Student_Name} (Grade: ${student.overallGrade}). Max 14 words.` :
                `Positive analytical data insight for ${student.Student_Name} (${student.overallPerc}%). Max 14 words.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Maintains a focus on excellence.";
            } catch (e) { return "Maintains positive progress."; }
        }

        async function generateAIIntelligenceRemark(student) { return await generateAIRemark(student, 'ai'); }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            setLoading(true, "Processing Workbook...");
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    processData(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]));
                } catch (err) { showToast("Excel Error", "error"); setLoading(false); }
            };
            reader.readAsArrayBuffer(file);
        }

        async function processData(raw) {
            const cls = document.getElementById('upload-class-select').value;
            const sec = document.getElementById('upload-section-input').value.trim().toUpperCase() || 'A';
            const key = `${cls}-${sec}`;
            const subjects = window.classSectionSubjectMap[key];

            const newRecords = raw.map((r, i) => {
                const row = {};
                Object.keys(r).forEach(k => row[k.trim()] = r[k]);
                const results = subjects.map(s => {
                    const k = s.replace(/\s+/g, '_');
                    const m = { pt1: Number(row[`${k}_PT_I`] || 0), hy: Number(row[`${k}_Half_Yearly`] || 0), pt2: Number(row[`${k}_PT_II`] || 0), an: Number(row[`${k}_Annual`] || 0) };
                    const total = m.pt1 + m.hy + m.pt2 + m.an;
                    const perc = (total / 200) * 100;
                    const g = getGrade(perc);
                    return { name: s, ...m, total, perc, grade: g.l, gradeClass: g.c };
                });
                const grandObtained = results.reduce((a, b) => a + b.total, 0);
                const overallPerc = (grandObtained / (subjects.length * 200)) * 100;
                const og = getGrade(overallPerc);
                return { 
                    Student_Name: row['Student_Name'] || row['Name'] || 'Student', 
                    Admission_No: row['Admission_No'] || row['Adm_No'] || (Date.now() + i), 
                    Roll_No: row['Roll_No'] || i + 1,
                    Father_Name: row['Father_Name'] || 'Guardian',
                    Mother_Name: row['Mother_Name'] || 'Guardian',
                    results, overallPerc: overallPerc.toFixed(1), overallGrade: og.l, overallGradeClass: og.c, status: overallPerc >= 33 ? "PASSED" : "PROMOTED WITH CARE", 
                    aiIntelligenceRemark: "", teacherAppraisal: "", Class: cls, Section: sec
                };
            });
            
            // Sync with Database
            await window.dbSync.saveStudents(newRecords, cls, sec);
            switchTab('result');
            setLoading(false);
        }

        async function previewStudent(id) {
            const s = window.studentsData.find(x => x.id === id);
            setLoading(true, "Finalizing Reports...");
            if (!s.aiIntelligenceRemark) s.aiIntelligenceRemark = await generateAIIntelligenceRemark(s);
            if (!s.teacherAppraisal) s.teacherAppraisal = await generateAIRemark(s, 'teacher');
            document.getElementById('view-result').classList.add('hidden');
            document.getElementById('preview-view').classList.remove('hidden');
            document.getElementById('single-report-container').innerHTML = generateReportHTML(s, 'single');
            lucide.createIcons();
            setTimeout(() => { renderPerformanceChart(s, 'single'); setLoading(false); }, 100);
        }

        function showListView() { document.getElementById('preview-view').classList.add('hidden'); document.getElementById('view-result').classList.remove('hidden'); }

        function generateReportHTML(s, pref) {
            const subjects = s.results;
            let rows = '';
            for (let i = 0; i < 8; i++) {
                const r = subjects[i];
                if (r) {
                    rows += `<tr class="marks-row">
                        <td class="border-r border-slate-300 font-bold bg-slate-50 uppercase text-slate-700 text-[11px]">${r.name}</td>
                        <td class="border-r border-slate-300 text-center text-[11px]">${r.pt1}</td>
                        <td class="border-r border-slate-300 text-center text-[11px]">${r.hy}</td>
                        <td class="border-r border-slate-300 text-center text-[11px]">${r.pt2}</td>
                        <td class="border-r border-slate-300 text-center text-[11px]">${r.an}</td>
                        <td class="border-r border-slate-300 text-center font-black text-[11px]">${r.total}</td>
                        <td class="text-center font-black ${r.gradeClass} text-[11px]">${r.grade}</td>
                    </tr>`;
                } else {
                    rows += `<tr class="marks-row">
                        <td class="border-r border-slate-300 bg-slate-50">&nbsp;</td>
                        <td class="border-r border-slate-300"></td><td class="border-r border-slate-300"></td><td class="border-r border-slate-300"></td><td class="border-r border-slate-300"></td><td class="border-r border-slate-300"></td><td></td>
                    </tr>`;
                }
            }

            return `<div id="report-${pref}" class="report-card-container page-break">
                <div class="header-box text-center border-b-[4px] border-blue-950 pb-4 mb-4">
                    <h1 class="text-4xl font-black text-blue-950 uppercase mb-0.5">UDAYA PUBLIC SCHOOL</h1>
                    <p class="text-[10px] font-black text-blue-800 uppercase tracking-[0.2em] mb-0.5">(Affiliated to CBSE, New Delhi)</p>
                    <p class="text-[8px] text-slate-500 font-bold uppercase tracking-wide">Mahadev Jharkhandi, Kunraghat, Gorakhpur, UP</p>
                    <div class="mt-2.5 inline-block bg-blue-950 text-white px-8 py-2 rounded-full font-black text-[9px] tracking-widest uppercase">${SCHOOL.sess}</div>
                </div>
                <div class="info-box grid grid-cols-2 gap-x-12 gap-y-1 bg-slate-50 p-5 rounded-2xl border border-slate-200 text-[10px] leading-tight font-semibold">
                    <div class="flex justify-between border-b border-slate-200 pb-0.5 uppercase">Student: <span class="text-blue-950 font-black">${s.Student_Name}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-0.5 uppercase">Adm No: <span class="font-black text-slate-700">${s.Admission_No}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-0.5 uppercase">Father: <span class="font-black text-slate-700">${s.Father_Name}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-0.5 uppercase">Mother: <span class="font-black text-slate-700">${s.Mother_Name}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-0.5 uppercase">Class: <span class="font-black text-slate-700">${s.Class} - ${s.Section}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-0.5 uppercase">Roll: <span class="font-black text-slate-700">${s.Roll_No}</span></div>
                </div>
                <div class="scholastic-box">
                    <h3 class="text-[9px] font-black text-blue-950 mb-1 border-l-4 border-blue-950 pl-3 uppercase">Scholastic Domain</h3>
                    <table class="marks-table border border-slate-300">
                        <thead class="bg-blue-950 text-white text-[8px] font-black uppercase">
                            <tr><th class="border border-slate-400">Subject</th><th class="border border-slate-400">PT-I</th><th class="border border-slate-400">HY</th><th class="border border-slate-400">PT-II</th><th class="border border-slate-400">AN</th><th class="border border-slate-400">Total</th><th class="border border-slate-400">Grade</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="metrics-row grid grid-cols-2 gap-10">
                    <div>
                        <h3 class="text-[9px] font-black text-blue-950 mb-1 border-l-4 border-blue-950 pl-3 uppercase">Co-Scholastic Metrics</h3>
                        <table class="w-full border border-slate-300 text-[9px] mb-2 leading-tight">
                            <tr class="border-b"><td class="p-1.5 bg-slate-50 uppercase font-bold text-[10px]">Art & Craft</td><td class="p-1.5 text-center font-black">${s.Art_Craft_Grade || 'A'}</td></tr>
                            <tr class="border-b"><td class="p-1.5 bg-slate-50 uppercase font-bold text-[10px]">Health & Phys Edu</td><td class="p-1.5 text-center font-black">${s.Sports_Grade || 'A'}</td></tr>
                            <tr class="border-b"><td class="p-1.5 bg-slate-50 uppercase font-bold text-[10px]">Discipline</td><td class="p-1.5 text-center font-black">${s.Discipline_Grade || 'A'}</td></tr>
                        </table>
                        <div class="p-3 bg-blue-50/50 border border-blue-100 rounded-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="sparkles" class="w-8 h-8 text-blue-900"></i></div>
                            <h4 class="text-[8px] font-black uppercase text-blue-600 mb-0.5 tracking-widest">AI Intelligence Remark</h4>
                            <p class="text-[10px] font-bold text-blue-900 italic leading-snug">"${s.aiIntelligenceRemark}"</p>
                        </div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-3xl p-4 flex flex-col items-center">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Performance Analytics</p>
                        <div class="h-full w-full"><canvas id="chart-${pref}"></canvas></div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-3" style="height: 18mm;">
                    <div class="bg-blue-950 text-white p-2 rounded-[1rem] text-center flex flex-col justify-center items-center shadow-lg">
                        <p class="text-[8px] uppercase mb-0.5 font-black opacity-60">AGGREGATE SCORE</p>
                        <p class="text-2xl font-black">${s.overallPerc}%</p>
                    </div>
                    <div class="bg-white border-2 border-slate-100 p-2 rounded-[1rem] text-center flex flex-col justify-center items-center">
                        <p class="text-[8px] uppercase mb-0.5 text-slate-400 font-black">FINAL GRADE</p>
                        <p class="text-2xl font-black text-blue-950">${s.overallGrade}</p>
                    </div>
                    <div class="p-2 rounded-[1rem] border-2 text-center flex flex-col justify-center items-center ${s.status === 'PASSED' ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'}">
                        <p class="text-[8px] uppercase mb-0.5 opacity-60 font-black">RESULT STATUS</p>
                        <p class="text-xl font-black ${s.status === 'PASSED' ? 'text-emerald-700' : 'text-red-700'}">${s.status}</p>
                    </div>
                </div>
                <div class="mb-3" style="height: 16mm;">
                    <h4 class="text-[8px] font-black uppercase text-slate-400 mb-1 tracking-widest">Class Teacher's Appraisal</h4>
                    <div class="px-4 py-1 bg-slate-50 border border-slate-200 rounded-2xl text-[10.5px] font-semibold text-slate-700 italic leading-snug h-full flex items-center">
                        "${s.teacherAppraisal || "Demonstrates consistent focus on Excellence."}"
                    </div>
                </div>
                <div class="footer-sigs flex justify-between items-end">
                    <div class="text-center w-[33%]"><div class="w-28 h-px bg-slate-900 mb-2 mx-auto"></div><p class="text-[10px] font-black uppercase tracking-widest">Class Teacher</p></div>
                    <div class="text-center w-[33%]"><div class="w-28 h-px bg-slate-900 mb-2 mx-auto"></div><p class="text-[10px] font-black uppercase tracking-widest">Guardian</p></div>
                    <div class="text-center w-[33%]"><div class="w-28 h-px bg-slate-900 mb-2 mx-auto"></div><p class="text-[10px] font-black uppercase tracking-widest">Principal</p></div>
                </div>
            </div>`;
        }

        function renderPerformanceChart(s, pref) {
            const ctx = document.getElementById(`chart-${pref}`);
            if (!ctx) return;
            new Chart(ctx, {
                type: 'bar',
                data: { labels: s.results.map(r => r.name.toUpperCase()), datasets: [{ data: s.results.map(r => r.perc), backgroundColor: '#1e1b4b', borderRadius: 4, barThickness: 16 }] },
                options: { animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: { display: false }, ticks: { font: { size: 8, weight: 'bold' } } }, x: { grid: { display: false }, ticks: { font: { size: 8, weight: 'bold' } } } } }
            });
        }

        async function downloadSinglePDF() {
            const element = document.getElementById('report-single');
            const sName = window.studentsData.find(s => document.getElementById('report-single'))?.Student_Name || "Report";
            setLoading(true, "Generating PDF...");
            const opt = { margin: 0, filename: `Report_${sName.replace(/\s+/g, '_')}.pdf`, image: { type: 'jpeg', quality: 1.0 }, html2canvas: { scale: 2.5, useCORS: true, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: 'avoid-all' } };
            try { await html2pdf().set(opt).from(element).save(); showToast("Download Complete", "success"); } finally { setLoading(false); }
        }

        async function downloadBatchPDF() {
            const filteredData = getFilteredList();
            if (filteredData.length === 0) { showToast("No students in view", "error"); return; }
            setLoading(true, "Batch Assembly...");
            const container = document.getElementById('print-container');
            container.innerHTML = ''; container.style.left = '0'; container.style.zIndex = '200';
            const htmlChunks = []; let processed = 0;
            for(let s of filteredData) { 
                if (!s.aiIntelligenceRemark) s.aiIntelligenceRemark = await generateAIIntelligenceRemark(s);
                if (!s.teacherAppraisal) s.teacherAppraisal = await generateAIRemark(s, 'teacher');
                htmlChunks.push(generateReportHTML(s, `batch-${processed}`)); processed++;
                document.getElementById('loading-progress').innerText = `${processed} / ${filteredData.length} Analyzed`;
            }
            container.innerHTML = htmlChunks.join(''); lucide.createIcons();
            await new Promise(r => setTimeout(r, 1500));
            filteredData.forEach((s, idx) => renderPerformanceChart(s, `batch-${idx}`));
            await new Promise(r => setTimeout(r, 1000));
            const classFilter = document.getElementById('filter-class-select').value;
            const filename = classFilter === 'ALL' ? `Batch_Master_${Date.now()}.pdf` : `Class_${classFilter}_Reports.pdf`;
            const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 1.5, useCORS: true, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'legacy'] } };
            try { await html2pdf().set(opt).from(container).save(); showToast("Batch Download Complete", "success"); } catch (err) { showToast("PDF Failed", "error"); } finally { container.innerHTML = ''; container.style.left = '-10000px'; container.style.zIndex = '-100'; document.getElementById('loading-progress').innerText = ''; setLoading(false); }
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'} text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 font-black text-xs uppercase tracking-widest border border-white/20 animate-in slide-in-from-right-8 duration-300`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check' : 'alert-circle'}" class="w-4 h-4"></i> ${msg}`;
            container.appendChild(toast); lucide.createIcons();
            setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.remove(), 500); }, 4000);
        }
        
        function downloadTemplate() {
            const cls = document.getElementById('upload-class-select').value;
            const sec = document.getElementById('upload-section-input').value.trim().toUpperCase() || 'A';
            const subjects = window.classSectionSubjectMap[`${cls}-${sec}`] || [];
            const h = ["Admission_No", "Student_Name", "Father_Name", "Mother_Name", "Date_of_Birth", "Class", "Section", "Roll_No"];
            subjects.forEach(s => { const k = s.replace(/\s+/g, '_'); h.push(`${k}_PT_I`, `${k}_Half_Yearly`, `${k}_PT_II`, `${k}_Annual`); });
            h.push("Art_Craft_Grade", "Sports_Grade", "Discipline_Grade", "Attendance", "Teacher_Remark");
            const ws = XLSX.utils.aoa_to_sheet([h]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "MarksData"); XLSX.writeFile(wb, `UDAYA_Template_${cls}_${sec}.xlsx`);
        }

        function setLoading(v, text) { document.getElementById('loading-text').innerText = text || "Syncing Cloud..."; document.getElementById('loading-overlay').classList.toggle('hidden', !v); }

        window.renderClassList();
    </script>
</body>
</html>
